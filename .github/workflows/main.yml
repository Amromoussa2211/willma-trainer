name: Android Emulator Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    env:
      NODE_VERSION: 18
      JAVA_VERSION: 17
      ANDROID_SDK_VERSION: 34
      ANDROID_BUILD_TOOLS_VERSION: 34.0.0
      ANDROID_EMU_VERSION: 34
      EMULATOR_TIMEOUT: 300
      AVD_CACHE_VERSION: 2
      EMULATOR_ARGS: -no-window -gpu swiftshader_indirect -no-snapshot -no-audio -memory 2048 -cores 2 -accel on -no-boot-anim
      APK_PACKAGE: com.willma.client.staging
      APK_PATH: ./app-release-trainer.apk  # fallback, gets overwritten by artifact step if needed

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Download APK artifact
        uses: actions/download-artifact@v4
        with:
          name: trainer-apk
          path: .

      - name: Setup Android SDK
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 31
          target: default
          arch: x86_64
          profile: Pixel_5
          script: echo "Emulator ready"

      - name: Grant execute permission to Gradle wrapper
        run: chmod +x ./gradlew

      - name: Install App on Emulator
        run: adb install -t -g $APK_PATH

      - name: Install dependencies
        run: npm ci

      - name: Run Tests
        run: |
          echo "Running WebdriverIO tests"
          npx wdio wdio.ci.conf.js

      - name: Upload Allure Results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: allure-results
          path: allure-results
