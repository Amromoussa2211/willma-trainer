name: Android CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-android:
    runs-on: ubuntu-latest

    env:
      NODE_VERSION: 18
      JAVA_VERSION: 17
      ANDROID_SDK_VERSION: 34
      ANDROID_BUILD_TOOLS_VERSION: 34.0.0
      ANDROID_EMU_VERSION: 34
      EMULATOR_TIMEOUT: 300
      AVD_CACHE_VERSION: 2
      EMULATOR_ARGS: -no-window -gpu swiftshader_indirect -no-snapshot -no-audio -memory 2048 -cores 2 -accel on -no-boot-anim
      APK_PACKAGE: com.willma.client.staging
      APK_PATH: ${{ github.workspace }}/app.apk  # CI path only

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Set up Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Download APK artifact
        uses: actions/download-artifact@v3
        with:
          name: trainer-apk
          path: .

      - name: Rename APK
        run: mv ./app-release-trainer.apk app.apk

      - name: Install AVD dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils

      - name: Start Android Emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 31
          arch: x86_64
          profile: pixel  # ‚úÖ Using a stable device profile
          emulator-options: -no-window -no-audio -gpu swiftshader_indirect
          disable-animations: true
          script: |
            echo "‚è≥ Waiting for emulator..."
            adb wait-for-device
            until adb shell getprop sys.boot_completed | grep -m 1 '1'; do
              echo "‚åõ Booting..."
              sleep 5
            done

            echo "‚úÖ Installing APK at path: $APK_PATH"
            adb install -t -g "$APK_PATH"

            echo "üì¶ Installing dependencies"
            npm ci

            echo "üöÄ Running WebDriverIO tests"
            npx wdio run ./ci.conf.js
