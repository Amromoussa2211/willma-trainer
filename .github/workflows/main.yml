name: Android E2E Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Dependencies
        run: npm install
      
      - name: Download APK
        run: |
          FILEID="1vpmsQks5b_Q5rUGvsLUahrHwkOlu3Mtz"
          FILENAME="app.apk"
          
          # Get the download cookie and confirm code
          COOKIES=$(curl -sc /tmp/cookie "https://drive.google.com/uc?export=download&id=${FILEID}" | grep -o 'download_warning.*' | cut -d'=' -f2)
          
          # Download the file with confirmation
          curl -Lb /tmp/cookie "https://drive.google.com/uc?export=download&confirm=${COOKIES}&id=${FILEID}" -o ${FILENAME}
          
          # Verify file was downloaded and is an APK
          if [ ! -f ${FILENAME} ]; then
            echo "Failed to download APK file"
            exit 1
          fi
          
          # Check file type
          if ! file ${FILENAME} | grep -q "Zip archive data" && ! file ${FILENAME} | grep -q "Android package"; then
            echo "Downloaded file is not a valid APK"
            exit 1
          fi
          
          echo "APK downloaded successfully and verified"
          echo "APK_PATH=$(pwd)/${FILENAME}" >> $GITHUB_ENV

      - name: Run Emulator and Tests
        uses: ReactiveCircus/android-emulator-runner@v2
        with:
          api-level: 29
          target: google_apis
          arch: x86_64
          ram-size: 4096M
          disk-size: 8192M
          cores: 4
          profile: pixel_4
          emulator-boot-timeout: 600
          disable-animations: true
          force-avd-creation: false
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim
          script: |
            # Verify APK exists
            if [ ! -f app.apk ]; then
              echo "APK file not found"
              exit 1
            fi
            
            # Install APK with verbose output
            adb install -r -t -g app.apk || {
              echo "APK installation failed"
              adb logcat -d > installation_failure.log
              cat installation_failure.log
              exit 1
            }
            
            # Verify installation
            if adb shell pm list packages | grep -q "com.willma.staging"; then
              echo "APK installed successfully"
              npm run test:ci
            else
              echo "Package not found after installation"
              exit 1
            fi

      - name: Upload Screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-screenshots
          path: screenshots/

      - name: Upload Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs
          path: |
            appium.log
            device.log

  notify-manager:
    needs: e2e-tests
    if: always() && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Send Email Notification
        uses: dawidd6/action-send-mail@v5
        with:
          server_address: smtp.office365.com
          server_port: 587
          secure: false
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "Android Tests Update - ${{ github.event.head_commit.message }}"
          to: fady@wilma.life, amr.ibrahim@willma.life
          from: "Willma CI/CD <${{ secrets.SMTP_USER }}>"
          html_body: |
            <div style="font-family: Arial, sans-serif; padding: 20px;">
              <h2 style="color: #1a73e8;">New Android Test Deployment</h2>
              <div style="background-color: #f8f9fa; padding: 15px; border-radius: 5px;">
                <p><strong>üì¶ Repository:</strong> ${{ github.repository }}</p>
                <p><strong>üîë Commit ID:</strong> <code>${{ github.sha }}</code></p>
                <p><strong>üë§ Author:</strong> ${{ github.actor }}</p>
                <p><strong>üìù Message:</strong> ${{ github.event.head_commit.message }}</p>
                <p><strong>üìÖ Date:</strong> ${{ github.event.head_commit.timestamp }}</p>
              </div>
              <p style="margin-top: 20px;">
                <a href="${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
                   style="background-color: #1a73e8; color: white; padding: 10px 15px; text-decoration: none; border-radius: 4px;">
                  View Full Commit Details
                </a>
              </p>
              <p style="margin-top: 20px; color: #666;">
                Workflow Status: ${{ job.status }}<br>
                This is an automated notification from Willma CI/CD System
              </p>
            </div>