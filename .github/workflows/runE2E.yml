name: Android E2E Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    env:
      AVD_NAME: testAVD
      ANDROID_AVD_HOME: $HOME/.android/avd

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v3

      - name: ðŸ§± Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: ðŸ“¦ Install Dependencies
        run: npm install

      - name: â˜• Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: ðŸ“¦ Install Android SDK & Required Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip wget
          mkdir -p $ANDROID_HOME/cmdline-tools
          wget https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O tools.zip
          unzip tools.zip -d $ANDROID_HOME/cmdline-tools
          mv $ANDROID_HOME/cmdline-tools/cmdline-tools $ANDROID_HOME/cmdline-tools/latest
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install \
            "platform-tools" \
            "emulator" \
            "platforms;android-34" \
            "system-images;android-34;google_apis;x86_64" \
            "build-tools;34.0.0"
          echo "$ANDROID_HOME/emulator" >> $GITHUB_PATH
          echo "$ANDROID_HOME/platform-tools" >> $GITHUB_PATH

      - name: ðŸ”§ KVM Setup
        run: |
          sudo apt-get install -y qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils
          sudo gpasswd -a $USER kvm
          sudo chmod 666 /dev/kvm

      - name: ðŸ“± Create and Configure AVD
        run: |
          mkdir -p "$ANDROID_AVD_HOME"
          echo "no" | $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager create avd \
            --name "$AVD_NAME" \
            --package "system-images;android-34;google_apis;x86_64" \
            --device "pixel" --force
          CONFIG_FILE="$ANDROID_AVD_HOME/${AVD_NAME}.avd/config.ini"
          for i in {1..30}; do
            [ -f "$CONFIG_FILE" ] && break
            sleep 2
          done
          if [ -f "$CONFIG_FILE" ]; then
            echo "hw.ramSize=4096" >> "$CONFIG_FILE"
            echo "hw.gpu.enabled=yes" >> "$CONFIG_FILE"
            echo "hw.gpu.mode=swiftshader_indirect" >> "$CONFIG_FILE"
          else
            echo "::error::AVD config.ini not found at $CONFIG_FILE"
            ls -l "$ANDROID_AVD_HOME"
            exit 1
          fi

      - name: ðŸš€ Start Emulator
        run: |
          nohup $ANDROID_HOME/emulator/emulator -avd "$AVD_NAME" -no-audio -no-window -gpu swiftshader_indirect -no-boot-anim -no-snapshot-load &

      - name: â³ Wait for Emulator to Boot
        run: |
          adb wait-for-device
          boot_completed=""
          timeout=480
          count=0
          until [[ "$boot_completed" == "1" || $count -ge $timeout ]]; do
            boot_completed=$(adb shell getprop sys.boot_completed | tr -d '\r')
            echo "Waiting for emulator to boot... ($count s) - boot_completed: $boot_completed"
            sleep 5
            count=$((count + 5))
          done
          if [ "$boot_completed" != "1" ]; then
            echo "::error::Emulator failed to boot"
            adb shell getprop
            exit 1
          fi

      - name: ðŸ”‡ Disable Animations
        run: |
          adb shell settings put global window_animation_scale 0
          adb shell settings put global transition_animation_scale 0
          adb shell settings put global animator_duration_scale 0

      - name: â¬‡ï¸ Download APKs
        run: |
          pip install --user gdown
          ~/.local/bin/gdown --fuzzy "https://drive.google.com/file/d/1moB6CyW6wC5MJDlDlfkT_TZ0QIfsuNEz/view?usp=drive_link" -O app-release-trainer.apk
          ~/.local/bin/gdown --fuzzy "https://drive.google.com/file/d/1cJH7DtaorZNJt6oUGiuWrnBxEh6VjJmY/view?usp=drive_link" -O appclient.apk

      - name: ðŸ” Verify Downloaded APKs
        run: |
          echo "--- app-release-trainer.apk ---"
          ls -l app-release-trainer.apk
          $ANDROID_HOME/build-tools/34.0.0/aapt dump badging app-release-trainer.apk | grep -E "package:|launchable-activity"

          echo "--- appclient.apk ---"
          ls -l appclient.apk
          $ANDROID_HOME/build-tools/34.0.0/aapt dump badging appclient.apk | grep -E "package:|launchable-activity"

      - name: ðŸ“‹ Check Current Package State
        run: |
          echo "=== Current installed packages ==="
          adb shell pm list packages | grep willma || echo "No willma packages found"
          
          echo "=== Package details if they exist ==="
          for PACKAGE in com.willma.staging com.willma.client.staging; do
            echo "--- $PACKAGE ---"
            adb shell dumpsys package $PACKAGE | grep -E "versionName|signatures|firstInstallTime" || echo "Package $PACKAGE not found"
          done

      - name: ðŸ§¹ Force Uninstall and Clean Install APKs
        run: |
      - name: ðŸ§¹ Force Uninstall and Clean Install APKs
        run: |
          echo "=== PHASE 1: Nuclear Package Cleanup ==="
          
          # First, restart package manager to clear caches
          echo "Restarting package manager..."
          adb shell stop
          sleep 3
          adb shell start
          adb wait-for-device
          
          # Wait for system to fully boot again
          boot_completed=""
          timeout=120
          count=0
          until [[ "$boot_completed" == "1" || $count -ge $timeout ]]; do
            boot_completed=$(adb shell getprop sys.boot_completed | tr -d '\r')
            echo "Waiting for system restart... ($count s) - boot_completed: $boot_completed"
            sleep 2
            count=$((count + 2))
          done
          
          for PACKAGE in com.willma.staging com.willma.client.staging; do
            echo "=== Deep cleanup for $PACKAGE ==="
            
            # Kill everything related to this package
            adb shell am force-stop $PACKAGE || true
            adb shell killall $PACKAGE 2>/dev/null || true
            
            # Clear all possible data locations
            adb shell pm clear $PACKAGE || true
            
            # Comprehensive uninstall attempts
            adb shell pm uninstall --user 0 $PACKAGE || true
            adb shell pm uninstall -k --user 0 $PACKAGE || true
            adb shell pm uninstall --user all $PACKAGE || true
            adb uninstall $PACKAGE || true
            
            # Get all users and try to uninstall from each
            USER_IDS=$(adb shell pm list users | grep -o 'UserInfo{[0-9]*' | cut -d'{' -f2 | tr '\n' ' ')
            for USER_ID in $USER_IDS; do
              adb shell pm uninstall --user $USER_ID $PACKAGE 2>/dev/null || true
            done
            
            # Try to disable and hide the package if it still exists
            adb shell pm disable-user --user 0 $PACKAGE 2>/dev/null || true
            adb shell pm hide --user 0 $PACKAGE 2>/dev/null || true
            
            # Manual cleanup of package directories
            adb shell rm -rf /data/data/$PACKAGE 2>/dev/null || true
            adb shell rm -rf /data/user/0/$PACKAGE 2>/dev/null || true
            adb shell rm -rf /data/user_de/0/$PACKAGE 2>/dev/null || true
            
            echo "Intensive cleanup completed for $PACKAGE"
          done
          
          # Clear package manager caches
          echo "Clearing package manager caches..."
          adb shell pm clear com.google.android.packageinstaller || true
          adb shell pm clear com.android.packageinstaller || true
          adb shell pm trim-caches 1000000000 || true
          
          # Restart package manager again to ensure clean state
          echo "Final package manager restart..."
          adb shell stop
          sleep 5
          adb shell start
          adb wait-for-device
          
          # Wait for system to be ready
          boot_completed=""
          timeout=120
          count=0
          until [[ "$boot_completed" == "1" || $count -ge $timeout ]]; do
            boot_completed=$(adb shell getprop sys.boot_completed | tr -d '\r')
            echo "Waiting for final system restart... ($count s)"
            sleep 2
            count=$((count + 2))
          done
          
          # Ultimate verification
          echo "=== Final verification of cleanup ==="
          REMAINING=$(adb shell pm list packages | grep willma || echo "")
          if [[ -n "$REMAINING" ]]; then
            echo "::error::CRITICAL: Packages still detected after nuclear cleanup:"
            echo "$REMAINING"
            # Let's see detailed package info
            for line in $REMAINING; do
              PKG=$(echo $line | cut -d':' -f2)
              echo "--- Details for $PKG ---"
              adb shell dumpsys package $PKG | grep -E "pkg=|codePath=|signatures=" || true
            done
            echo "Attempting to proceed anyway..."
          else
            echo "âœ… Nuclear cleanup successful - no willma packages detected"
          fi

          # Install with maximum aggressive settings
          echo "=== PHASE 2: Installing APKs with maximum force ==="
          
          # Disable all verification systems
          adb shell settings put global verifier_verify_adb_installs 0 || true
          adb shell settings put global package_verifier_enable 0 || true
          adb shell settings put secure install_non_market_apps 1 || true
          adb shell settings put global development_settings_enabled 1 || true
          
          echo "Installing Trainer APK..."
          if adb install -r -d -g --force-sdk --bypass-low-target-sdk-block app-release-trainer.apk 2>&1; then
            echo "âœ… Trainer APK installed successfully"
          else
            echo "::error::âŒ Trainer APK install failed"
            exit 1
          fi

          echo "Installing Client APK with maximum force..."
          # Try the most aggressive install possible
          if adb install -r -d -g --force-sdk --bypass-low-target-sdk-block --force-queryable appclient.apk 2>&1; then
            echo "âœ… Client APK installed successfully"
          else
            echo "âŒ Direct install failed, trying push method..."
            # Alternative method: push and install manually
            adb push appclient.apk /data/local/tmp/appclient.apk
            if adb shell pm install -r -d -g --force-sdk /data/local/tmp/appclient.apk 2>&1; then
              echo "âœ… Client APK installed via push method"
              adb shell rm /data/local/tmp/appclient.apk
            else
              echo "::error::âŒ All installation methods failed for client APK"
              echo "Final package state:"
              adb shell pm list packages | grep willma
              echo "Detailed error info:"
              adb logcat -d | grep -E "PackageManager|INSTALL_FAILED" | tail -30
              exit 1
            fi
          fi

      - name: âœ… Verify Both APKs Are Installed
        run: |
          echo "=== Final Installation Verification ==="
          
          # Check if both packages are listed
          INSTALLED_PACKAGES=$(adb shell pm list packages | grep willma)
          echo "Installed willma packages:"
          echo "$INSTALLED_PACKAGES"
          
          # Verify specific packages
          TRAINER_INSTALLED=$(adb shell pm list packages | grep com.willma.staging || echo "")
          CLIENT_INSTALLED=$(adb shell pm list packages | grep com.willma.client.staging || echo "")
          
          if [[ -z "$TRAINER_INSTALLED" ]]; then
            echo "::error::âŒ Trainer package (com.willma.staging) not found!"
            exit 1
          else
            echo "âœ… Trainer package confirmed: $TRAINER_INSTALLED"
          fi
          
          if [[ -z "$CLIENT_INSTALLED" ]]; then
            echo "::error::âŒ Client package (com.willma.client.staging) not found!"
            exit 1
          else
            echo "âœ… Client package confirmed: $CLIENT_INSTALLED"
          fi
          
          # Get detailed info about both packages
          echo "=== Package Details ==="
          for PACKAGE in com.willma.staging com.willma.client.staging; do
            echo "--- $PACKAGE ---"
            adb shell dumpsys package $PACKAGE | grep -E "versionName|versionCode|firstInstallTime"
          done
          
          # Test that we can launch both apps (optional)
          echo "=== Testing App Launch Capability ==="
          adb shell monkey -p com.willma.staging -c android.intent.category.LAUNCHER 1 || echo "Warning: Could not launch trainer app"
          sleep 2
          adb shell monkey -p com.willma.client.staging -c android.intent.category.LAUNCHER 1 || echo "Warning: Could not launch client app"
          
          echo "ðŸŽ‰ Both APKs are successfully installed and verified!"

      - name: ðŸ§ª Start Appium Server
        run: |
          mkdir -p logs
          nohup npx appium --relaxed-security --log-timestamp > logs/appium.log 2>&1 &
          sleep 10

      - name: ðŸ§ª Run E2E Tests
        run: |
          npx wdio run ./wdio.ci.conf.js
        continue-on-error: true

      - name: ðŸ“· Collect Diagnostics
        if: always()
        run: |
          mkdir -p diagnostics
          adb logcat -d > diagnostics/logcat.log
          adb shell cat /data/anr/traces.txt > diagnostics/anr-traces.log || true
          cp -r screenshots diagnostics/ || true
          cp -r logs/ diagnostics/ || true
          
          # Add package state to diagnostics
          echo "=== Final Package State ===" > diagnostics/final-package-state.log
          adb shell pm list packages | grep willma >> diagnostics/final-package-state.log || echo "No willma packages" >> diagnostics/final-package-state.log

      - name: ðŸ“¤ Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-results-${{ github.run_id }}
          path: diagnostics/
          retention-days: 7

      - name: ðŸ›‘ Kill Emulator
        if: always()
        run: |
          adb emu kill || true
          pkill -f 'qemu-system' || true
          pkill -f 'emulator' || true